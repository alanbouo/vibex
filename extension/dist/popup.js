(()=>{async function e(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return e}function t(e){return e&&(e.includes("twitter.com")||e.includes("x.com"))}function n(e){try{const t=new URL(e).pathname.split("/").filter(e=>e);if(t.length>0&&!["home","explore","notifications","messages","search"].includes(t[0]))return t[0]}catch(e){}return null}async function s(){chrome.runtime.sendMessage({action:"getStorageStats"},e=>{if(e&&e.success){const{postsCount:t,likesCount:n,repliesCount:s,postsUpdated:i,likesUpdated:a,repliesUpdated:l}=e.stats;document.getElementById("postsCount").textContent=t,document.getElementById("likesCount").textContent=n,document.getElementById("repliesCount").textContent=s||0,document.getElementById("postsUpdated").textContent=i?o(i):"Not collected",document.getElementById("likesUpdated").textContent=a?o(a):"Not collected",document.getElementById("repliesUpdated").textContent=l?o(l):"Not collected";const d=t+n+(s||0);d>0&&c("success",`${d} items collected`)}})}function o(e){const t=new Date(e),n=new Date-t,s=Math.floor(n/6e4),o=Math.floor(n/36e5),c=Math.floor(n/864e5);return s<1?"Just now":s<60?`${s}m ago`:o<24?`${o}h ago`:c<7?`${c}d ago`:t.toLocaleDateString()}function c(e,t){const n=document.getElementById("statusBar"),s=document.getElementById("statusText");n.className="status-bar","warning"===e&&n.classList.add("warning"),"error"===e&&n.classList.add("error"),s.textContent=t}async function i(){return new Promise(e=>{chrome.storage.local.get(["vibex_posts","vibex_likes","vibex_replies"],t=>{e({posts:t.vibex_posts||[],likes:t.vibex_likes||[],replies:t.vibex_replies||[]})})})}function a(){chrome.runtime.sendMessage({action:"checkAuth"},e=>{e&&e.authenticated?l(e.user):d()})}function l(e){document.getElementById("accountNotConnected").style.display="none",document.getElementById("accountConnected").style.display="block",document.getElementById("userName").textContent=e?.name||"Connected",document.getElementById("userEmail").textContent=e?.email||"",document.getElementById("syncBtn").disabled=!1}function d(){document.getElementById("accountNotConnected").style.display="block",document.getElementById("accountConnected").style.display="none",document.getElementById("syncBtn").disabled=!0}document.addEventListener("DOMContentLoaded",()=>{a(),s(),window.addEventListener("focus",()=>{a()}),document.getElementById("collectPosts").addEventListener("click",async()=>{const n=await e();t(n.url)?!n.url.includes("/status/")&&n.url.split("/").length<=4?(chrome.tabs.sendMessage(n.id,{action:"collectPosts"}),c("success","Collecting posts..."),window.close()):c("warning","Go to your profile page to collect posts"):c("warning","Please navigate to x.com first")}),document.getElementById("collectLikes").addEventListener("click",async()=>{const s=await e();if(t(s.url))if(s.url.includes("/likes"))chrome.tabs.sendMessage(s.id,{action:"collectLikes"}),c("success","Collecting likes..."),window.close();else{const e=n(s.url);e?(chrome.tabs.update(s.id,{url:`https://x.com/${e}/likes`}),c("success","Navigating to likes page...")):c("warning","Go to your profile/likes page first")}else c("warning","Please navigate to x.com first")}),document.getElementById("collectReplies").addEventListener("click",async()=>{const s=await e();if(!t(s.url))return void c("warning","Please navigate to x.com first");const o=n(s.url);if(o){const e=`https://x.com/search?q=${encodeURIComponent(`from:${o} filter:replies`)}&src=typed_query&f=live`;chrome.tabs.update(s.id,{url:e}),c("success","Navigating to replies search...")}else c("warning","Go to your profile page first")}),document.getElementById("openWriter").addEventListener("click",async()=>{const n=await e();t(n.url)?(chrome.tabs.sendMessage(n.id,{action:"openWriter"}),window.close()):c("warning","Please navigate to x.com first")}),document.getElementById("exportData").addEventListener("click",async()=>{const n=await e();t(n.url)?(chrome.tabs.sendMessage(n.id,{action:"exportData"}),window.close()):async function(){const e=await i(),t={exportedAt:(new Date).toISOString(),posts:e.posts,likes:e.likes,replies:e.replies},n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(n);chrome.downloads.download({url:s,filename:`vibex-export-${(new Date).toISOString().split("T")[0]}.json`,saveAs:!0})}()}),document.getElementById("openDashboard").addEventListener("click",()=>{chrome.runtime.sendMessage({action:"openDashboard"})}),document.getElementById("clearData").addEventListener("click",()=>{confirm("Are you sure you want to clear all collected data?")&&chrome.storage.local.remove(["vibex_posts","vibex_likes","vibex_replies","vibex_posts_updated","vibex_likes_updated","vibex_replies_updated"],()=>{s(),c("success","Data cleared successfully")})}),document.getElementById("openSettings").addEventListener("click",()=>{chrome.tabs.create({url:"https://vibex.alanbouo.com/settings"})}),document.getElementById("syncBtn").addEventListener("click",async()=>{const e=document.getElementById("syncBtn");e.disabled=!0,e.textContent="Syncing...",c("warning","Syncing to cloud...");const t=await i();chrome.runtime.sendMessage({action:"syncToBackend",data:{posts:t.posts,likes:t.likes}},t=>{if(e.disabled=!1,e.textContent="Sync to Cloud",t&&t.success)c("success","Synced successfully!");else{const e=t?.error||"Unknown error";console.error("Sync failed:",e),c("error",`Sync failed: ${e.substring(0,50)}`)}})}),document.getElementById("helpLink").addEventListener("click",e=>{e.preventDefault(),chrome.tabs.create({url:"https://github.com/vibex/docs"})}),document.getElementById("feedbackLink").addEventListener("click",e=>{e.preventDefault(),chrome.tabs.create({url:"https://github.com/vibex/feedback"})}),document.getElementById("connectBtn").addEventListener("click",()=>{const e=document.getElementById("connectBtn");e.disabled=!0,e.innerHTML='<span class="btn-icon">â³</span> Connecting...',c("warning","Connecting to Vibex..."),chrome.runtime.sendMessage({action:"connectAccount"},t=>{e.disabled=!1,e.innerHTML='<span class="btn-icon">ğŸ”—</span> Connect to Vibex',t.success?(l(t.user),c("success","Connected to Vibex!")):t.needsLogin?c("warning",t.message):t.error?.includes("timeout")?c("error","Backend not responding. Try again later."):c("error",t.error||"Connection failed")})}),document.getElementById("disconnectBtn").addEventListener("click",()=>{chrome.runtime.sendMessage({action:"disconnectAccount"},()=>{d(),c("success","Disconnected from Vibex")})})})})();