(()=>{async function e(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return e}function t(e){return e&&(e.includes("twitter.com")||e.includes("x.com"))}async function n(){chrome.runtime.sendMessage({action:"getStorageStats"},e=>{if(e&&e.success){const{postsCount:t,likesCount:n,postsUpdated:o,likesUpdated:a}=e.stats;document.getElementById("postsCount").textContent=t,document.getElementById("likesCount").textContent=n,document.getElementById("postsUpdated").textContent=o?s(o):"Not collected",document.getElementById("likesUpdated").textContent=a?s(a):"Not collected",(t>0||n>0)&&c("success",`${t+n} items collected`)}})}function s(e){const t=new Date(e),n=new Date-t,s=Math.floor(n/6e4),c=Math.floor(n/36e5),o=Math.floor(n/864e5);return s<1?"Just now":s<60?`${s}m ago`:c<24?`${c}h ago`:o<7?`${o}d ago`:t.toLocaleDateString()}function c(e,t){const n=document.getElementById("statusBar"),s=document.getElementById("statusText");n.className="status-bar","warning"===e&&n.classList.add("warning"),"error"===e&&n.classList.add("error"),s.textContent=t}async function o(){return new Promise(e=>{chrome.storage.local.get(["vibex_posts","vibex_likes"],t=>{e({posts:t.vibex_posts||[],likes:t.vibex_likes||[]})})})}function a(){chrome.runtime.sendMessage({action:"checkAuth"},e=>{e&&e.authenticated?i(e.user):d()})}function i(e){document.getElementById("accountNotConnected").style.display="none",document.getElementById("accountConnected").style.display="block",document.getElementById("userName").textContent=e?.name||"Connected",document.getElementById("userEmail").textContent=e?.email||"",document.getElementById("syncBtn").disabled=!1}function d(){document.getElementById("accountNotConnected").style.display="block",document.getElementById("accountConnected").style.display="none",document.getElementById("syncBtn").disabled=!0}document.addEventListener("DOMContentLoaded",()=>{a(),n(),window.addEventListener("focus",()=>{a()}),document.getElementById("collectPosts").addEventListener("click",async()=>{const n=await e();t(n.url)?!n.url.includes("/status/")&&n.url.split("/").length<=4?(chrome.tabs.sendMessage(n.id,{action:"collectPosts"}),c("success","Collecting posts..."),window.close()):c("warning","Go to your profile page to collect posts"):c("warning","Please navigate to x.com first")}),document.getElementById("collectLikes").addEventListener("click",async()=>{const n=await e();if(t(n.url))if(n.url.includes("/likes"))chrome.tabs.sendMessage(n.id,{action:"collectLikes"}),c("success","Collecting likes..."),window.close();else{const e=function(e){try{const t=new URL(e).pathname.split("/").filter(e=>e);if(t.length>0&&!["home","explore","notifications","messages","search"].includes(t[0]))return t[0]}catch(e){}return null}(n.url);e?(chrome.tabs.update(n.id,{url:`https://x.com/${e}/likes`}),c("success","Navigating to likes page...")):c("warning","Go to your profile/likes page first")}else c("warning","Please navigate to x.com first")}),document.getElementById("openWriter").addEventListener("click",async()=>{const n=await e();t(n.url)?(chrome.tabs.sendMessage(n.id,{action:"openWriter"}),window.close()):c("warning","Please navigate to x.com first")}),document.getElementById("exportData").addEventListener("click",async()=>{const n=await e();t(n.url)?(chrome.tabs.sendMessage(n.id,{action:"exportData"}),window.close()):async function(){const e=await o(),t={exportedAt:(new Date).toISOString(),posts:e.posts,likes:e.likes},n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(n);chrome.downloads.download({url:s,filename:`vibex-export-${(new Date).toISOString().split("T")[0]}.json`,saveAs:!0})}()}),document.getElementById("openDashboard").addEventListener("click",()=>{chrome.runtime.sendMessage({action:"openDashboard"})}),document.getElementById("clearData").addEventListener("click",()=>{confirm("Are you sure you want to clear all collected data?")&&chrome.storage.local.remove(["vibex_posts","vibex_likes","vibex_posts_updated","vibex_likes_updated"],()=>{n(),c("success","Data cleared successfully")})}),document.getElementById("openSettings").addEventListener("click",()=>{chrome.tabs.create({url:"https://vibex.alanbouo.com/settings"})}),document.getElementById("syncBtn").addEventListener("click",async()=>{c("warning","Syncing to cloud...");const e=await o();chrome.runtime.sendMessage({action:"syncToBackend",data:{posts:e.posts,likes:e.likes}},e=>{e&&e.success?c("success","Synced successfully!"):c("error","Sync failed. Check if you're logged in.")})}),document.getElementById("helpLink").addEventListener("click",e=>{e.preventDefault(),chrome.tabs.create({url:"https://github.com/vibex/docs"})}),document.getElementById("feedbackLink").addEventListener("click",e=>{e.preventDefault(),chrome.tabs.create({url:"https://github.com/vibex/feedback"})}),document.getElementById("connectBtn").addEventListener("click",()=>{c("warning","Connecting..."),chrome.runtime.sendMessage({action:"connectAccount"},e=>{e.success?(i(e.user),c("success","Connected to Vibex!")):e.needsLogin?c("warning",e.message):c("error",e.error||"Connection failed")})}),document.getElementById("disconnectBtn").addEventListener("click",()=>{chrome.runtime.sendMessage({action:"disconnectAccount"},()=>{d(),c("success","Disconnected from Vibex")})})})})();