(()=>{async function e(){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});return e}function t(e){return e&&(e.includes("twitter.com")||e.includes("x.com"))}async function n(){chrome.runtime.sendMessage({action:"getStorageStats"},e=>{if(e&&e.success){const{postsCount:t,likesCount:n,postsUpdated:c,likesUpdated:a}=e.stats;document.getElementById("postsCount").textContent=t,document.getElementById("likesCount").textContent=n,document.getElementById("postsUpdated").textContent=c?s(c):"Not collected",document.getElementById("likesUpdated").textContent=a?s(a):"Not collected",(t>0||n>0)&&o("success",`${t+n} items collected`)}})}function s(e){const t=new Date(e),n=new Date-t,s=Math.floor(n/6e4),o=Math.floor(n/36e5),c=Math.floor(n/864e5);return s<1?"Just now":s<60?`${s}m ago`:o<24?`${o}h ago`:c<7?`${c}d ago`:t.toLocaleDateString()}function o(e,t){const n=document.getElementById("statusBar"),s=document.getElementById("statusText");n.className="status-bar","warning"===e&&n.classList.add("warning"),"error"===e&&n.classList.add("error"),s.textContent=t}async function c(){return new Promise(e=>{chrome.storage.local.get(["vibex_posts","vibex_likes"],t=>{e({posts:t.vibex_posts||[],likes:t.vibex_likes||[]})})})}function a(){chrome.runtime.sendMessage({action:"checkAuth"},e=>{e&&e.authenticated?i(e.user):d()})}function i(e){document.getElementById("accountNotConnected").style.display="none",document.getElementById("accountConnected").style.display="block",document.getElementById("userName").textContent=e?.name||"Connected",document.getElementById("userEmail").textContent=e?.email||"",document.getElementById("syncBtn").disabled=!1}function d(){document.getElementById("accountNotConnected").style.display="block",document.getElementById("accountConnected").style.display="none",document.getElementById("syncBtn").disabled=!0}document.addEventListener("DOMContentLoaded",()=>{a(),n(),window.addEventListener("focus",()=>{a()}),document.getElementById("collectPosts").addEventListener("click",async()=>{const n=await e();t(n.url)?!n.url.includes("/status/")&&n.url.split("/").length<=4?(chrome.tabs.sendMessage(n.id,{action:"collectPosts"}),o("success","Collecting posts..."),window.close()):o("warning","Go to your profile page to collect posts"):o("warning","Please navigate to x.com first")}),document.getElementById("collectLikes").addEventListener("click",async()=>{const n=await e();if(t(n.url))if(n.url.includes("/likes"))chrome.tabs.sendMessage(n.id,{action:"collectLikes"}),o("success","Collecting likes..."),window.close();else{const e=function(e){try{const t=new URL(e).pathname.split("/").filter(e=>e);if(t.length>0&&!["home","explore","notifications","messages","search"].includes(t[0]))return t[0]}catch(e){}return null}(n.url);e?(chrome.tabs.update(n.id,{url:`https://x.com/${e}/likes`}),o("success","Navigating to likes page...")):o("warning","Go to your profile/likes page first")}else o("warning","Please navigate to x.com first")}),document.getElementById("openWriter").addEventListener("click",async()=>{const n=await e();t(n.url)?(chrome.tabs.sendMessage(n.id,{action:"openWriter"}),window.close()):o("warning","Please navigate to x.com first")}),document.getElementById("exportData").addEventListener("click",async()=>{const n=await e();t(n.url)?(chrome.tabs.sendMessage(n.id,{action:"exportData"}),window.close()):async function(){const e=await c(),t={exportedAt:(new Date).toISOString(),posts:e.posts,likes:e.likes},n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),s=URL.createObjectURL(n);chrome.downloads.download({url:s,filename:`vibex-export-${(new Date).toISOString().split("T")[0]}.json`,saveAs:!0})}()}),document.getElementById("openDashboard").addEventListener("click",()=>{chrome.runtime.sendMessage({action:"openDashboard"})}),document.getElementById("clearData").addEventListener("click",()=>{confirm("Are you sure you want to clear all collected data?")&&chrome.storage.local.remove(["vibex_posts","vibex_likes","vibex_posts_updated","vibex_likes_updated"],()=>{n(),o("success","Data cleared successfully")})}),document.getElementById("openSettings").addEventListener("click",()=>{chrome.tabs.create({url:"https://vibex.alanbouo.com/settings"})}),document.getElementById("syncBtn").addEventListener("click",async()=>{const e=document.getElementById("syncBtn");e.disabled=!0,e.textContent="Syncing...",o("warning","Syncing to cloud...");const t=await c();chrome.runtime.sendMessage({action:"syncToBackend",data:{posts:t.posts,likes:t.likes}},t=>{if(e.disabled=!1,e.textContent="Sync to Cloud",t&&t.success)o("success","Synced successfully!");else{const e=t?.error||"Unknown error";console.error("Sync failed:",e),o("error",`Sync failed: ${e.substring(0,50)}`)}})}),document.getElementById("helpLink").addEventListener("click",e=>{e.preventDefault(),chrome.tabs.create({url:"https://github.com/vibex/docs"})}),document.getElementById("feedbackLink").addEventListener("click",e=>{e.preventDefault(),chrome.tabs.create({url:"https://github.com/vibex/feedback"})}),document.getElementById("connectBtn").addEventListener("click",()=>{const e=document.getElementById("connectBtn");e.disabled=!0,e.innerHTML='<span class="btn-icon">â³</span> Connecting...',o("warning","Connecting to Vibex..."),chrome.runtime.sendMessage({action:"connectAccount"},t=>{e.disabled=!1,e.innerHTML='<span class="btn-icon">ğŸ”—</span> Connect to Vibex',t.success?(i(t.user),o("success","Connected to Vibex!")):t.needsLogin?o("warning",t.message):t.error?.includes("timeout")?o("error","Backend not responding. Try again later."):o("error",t.error||"Connection failed")})}),document.getElementById("disconnectBtn").addEventListener("click",()=>{chrome.runtime.sendMessage({action:"disconnectAccount"},()=>{d(),o("success","Disconnected from Vibex")})})})})();