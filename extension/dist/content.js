(()=>{console.log("Vibex extension v2.0 loaded");const e='[data-testid="tweet"]',t='[data-testid="tweetText"]',n='[data-testid="reply"]',i='[data-testid="retweet"]',o='[data-testid="like"]',s='[data-testid="views"]',l='[data-testid="tweetTextarea_0"]';let c=!1,r=[],a=[],d=null;function u(){console.log("Vibex: Initializing...");const e=b();"profile"!==e&&"likes"!==e||function(){if(document.getElementById("vibex-collector"))return;const e="likes"===b(),t=document.createElement("div");t.id="vibex-collector",t.className="vibex-collector",t.innerHTML=`\n    <div class="vibex-collector-header">\n      <svg class="vibex-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">\n        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n      </svg>\n      <span>Vibex Collector</span>\n      <button class="vibex-close" id="vibex-collector-close">&times;</button>\n    </div>\n    <div class="vibex-collector-body">\n      <p class="vibex-collector-status" id="vibex-status">Ready to collect ${e?"likes":"posts"}</p>\n      <div class="vibex-collector-actions">\n        <button class="vibex-btn vibex-btn-primary" id="vibex-collect-btn">\n          ${e?"‚ù§Ô∏è Collect Likes":"üìù Collect Posts"}\n        </button>\n        <button class="vibex-btn vibex-btn-secondary" id="vibex-export-btn">\n          üì• Export JSON\n        </button>\n      </div>\n      <div class="vibex-collector-stats" id="vibex-stats">\n        <span>Posts: <strong id="vibex-posts-count">0</strong></span>\n        <span>Likes: <strong id="vibex-likes-count">0</strong></span>\n      </div>\n    </div>\n  `,document.body.appendChild(t),document.getElementById("vibex-collect-btn").addEventListener("click",()=>{m(e?"likes":"posts")}),document.getElementById("vibex-export-btn").addEventListener("click",I),document.getElementById("vibex-collector-close").addEventListener("click",()=>{t.style.display="none"}),async function(){const e=await g("posts"),t=await g("likes"),n=document.getElementById("vibex-posts-count"),i=document.getElementById("vibex-likes-count");n&&(n.textContent=e.length),i&&(i.textContent=t.length),r=e,a=t}()}(),"compose"!==e&&"home"!==e||function(){const e=document.querySelector(l);if(!e||document.getElementById("vibex-writer-btn"))return;const t=document.createElement("button");t.id="vibex-writer-btn",t.className="vibex-writer-btn",t.innerHTML="‚ú® AI",t.title="Open Vibex AI Writer",t.addEventListener("click",h),e.parentElement.appendChild(t)}(),function(){if(document.getElementById("vibex-fab"))return;const e=document.createElement("div");e.id="vibex-fab",e.className="vibex-fab",e.innerHTML='\n    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">\n      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n    </svg>\n  ',e.title="Vibex Menu",document.body.appendChild(e),e.addEventListener("click",y)}(),chrome.runtime.onMessage.addListener(C),function(){let e=window.location.pathname;setInterval(()=>{const t=window.location.pathname;t!==e&&(e=t,["vibex-collector","vibex-menu","vibex-writer"].forEach(e=>{const t=document.getElementById(e);t&&t.remove()}),d=null,setTimeout(u,500))},1e3)}()}function b(){const e=window.location.pathname;return e.includes("/likes")?"likes":e.includes("/status/")?"tweet":"/compose/tweet"===e?"compose":"/home"===e?"home":2!==e.split("/").length||["home","explore","notifications","messages","search"].includes(e.split("/")[1])?"other":"profile"}function v(){const l=document.querySelectorAll(e),c=[];return l.forEach((e,l)=>{try{const l=function(e){const l=e.querySelector(t),c=l?l.innerText:"";let r="",a="";const d=e.querySelector('a[href*="/status/"]');if(d&&(r=d.href,a=r.split("/status/")[1]?.split("?")[0]?.split("/")[0]||""),!a){const t=e.querySelector("time")?.closest("a");t&&t.href.includes("/status/")&&(r=t.href,a=r.split("/status/")[1]?.split("?")[0]?.split("/")[0]||"")}const u=e.querySelector("time"),b=u?u.getAttribute("datetime"):"",v=u?u.innerText:"",m=function(e){const t=t=>{const n=e.querySelector(t);if(!n)return 0;const i=(n.innerText||n.getAttribute("aria-label")||"").match(/[\d,]+/);return i?parseInt(i[0].replace(/,/g,""),10):0};return{replies:t(n),retweets:t(i),likes:t(o),views:t(s)}}(e),x=function(e){const t=e.querySelector('[data-testid="User-Name"]');if(!t)return{author:"",handle:""};const n=t.querySelectorAll("a");return{author:n[0]?.innerText||"",handle:(n[1]?.innerText||n[0]?.href?.split("/").pop()||"").replace("@","")}}(e),p=function(e){const t=e.querySelector('[data-testid="socialContext"]');if(t&&t.textContent.includes("reposted"))return"retweet";if(e.querySelector('[data-testid="quoteTweet"]'))return"quote";const n=e.querySelector('div[data-testid="tweet"] > div > div > div > span');return n&&n.textContent.includes("Replying to")?"reply":"original"}(e),g=function(e){const t=null!==e.querySelector('[data-testid="tweetPhoto"]'),n=null!==e.querySelector('[data-testid="videoPlayer"]'),i=null!==e.querySelector('[data-testid="card.wrapper"]'),o=null!==e.querySelector('[data-testid="cardPoll"]'),s=[];return t&&s.push("image"),n&&s.push("video"),i&&s.push("card"),o&&s.push("poll"),{hasMedia:s.length>0,mediaTypes:s}}(e);return{id:a,text:c,url:r,timestamp:b,displayTime:v,type:p,...g,...m,...x,scrapedAt:(new Date).toISOString()}}(e);l&&l.id&&c.push(l)}catch(e){console.error("Vibex: Error scraping tweet",l,e)}}),c}async function m(e="posts"){if(c)return void x();c=!0;const t="likes"===e?a:r,n=new Set(t.map(e=>e.id));let i=0,o=0,s=0;for(f(`Collecting ${e}... (0 collected)`);c;){const l=v();let c=0;l.forEach(e=>{e.id&&!n.has(e.id)&&(n.add(e.id),t.push(e),c++)}),0===c?i++:i=0;const r=document.documentElement.scrollHeight,a=window.innerHeight+window.scrollY>=r-100;if(r===o&&a?s++:(s=0,o=r),f(`Collecting ${e}... (${t.length} collected)`),i>=10&&s>=5)break;window.scrollBy(0,.8*window.innerHeight),await p("likes"===e?2e3:1500),t.length%50==0&&t.length>0&&(f(`Collecting ${e}... (${t.length} collected) - pausing...`),await p(1e3))}return c=!1,f(`Done! ${t.length} ${e} collected`),function(e,t){const n="likes"===e?"vibex_likes":"vibex_posts",i={[n]:t,[`${n}_updated`]:(new Date).toISOString()};chrome.storage.local.set(i,()=>{console.log(`Vibex: Saved ${t.length} ${e} to storage`),chrome.runtime.sendMessage({action:"dataCollected",type:e,count:t.length})})}(e,t),t}function x(){c=!1,f("Collection stopped")}function p(e){return new Promise(t=>setTimeout(t,e))}function g(e){return new Promise(t=>{const n="likes"===e?"vibex_likes":"vibex_posts";chrome.storage.local.get([n],e=>{t(e[n]||[])})})}function y(){let e=document.getElementById("vibex-menu");e?e.remove():(e=document.createElement("div"),e.id="vibex-menu",e.className="vibex-menu",e.innerHTML='\n    <button class="vibex-menu-item" id="vibex-menu-collect">\n      üìù Collect Posts\n    </button>\n    <button class="vibex-menu-item" id="vibex-menu-likes">\n      ‚ù§Ô∏è Collect Likes\n    </button>\n    <button class="vibex-menu-item" id="vibex-menu-writer">\n      ‚úçÔ∏è AI Writer\n    </button>\n    <button class="vibex-menu-item" id="vibex-menu-export">\n      üì• Export Data\n    </button>\n    <button class="vibex-menu-item" id="vibex-menu-dashboard">\n      üìä Dashboard\n    </button>\n  ',document.body.appendChild(e),document.getElementById("vibex-menu-collect").addEventListener("click",()=>{e.remove(),m("posts")}),document.getElementById("vibex-menu-likes").addEventListener("click",()=>{e.remove();const t=window.location.pathname.split("/").filter(e=>e)[0]||null;t&&!window.location.pathname.includes("/likes")?window.location.href=`https://x.com/${t}/likes`:m("likes")}),document.getElementById("vibex-menu-writer").addEventListener("click",()=>{e.remove(),h()}),document.getElementById("vibex-menu-export").addEventListener("click",()=>{e.remove(),I()}),document.getElementById("vibex-menu-dashboard").addEventListener("click",()=>{e.remove(),chrome.runtime.sendMessage({action:"openDashboard"})}),setTimeout(()=>{document.addEventListener("click",function t(n){e.contains(n.target)||"vibex-fab"===n.target.id||(e.remove(),document.removeEventListener("click",t))})},100))}function h(){if(d)return d.remove(),void(d=null);d=document.createElement("div"),d.id="vibex-writer",d.className="vibex-writer",d.innerHTML='\n    <div class="vibex-writer-header">\n      <h3>‚ú® Vibex AI Writer</h3>\n      <button class="vibex-close" id="vibex-writer-close">&times;</button>\n    </div>\n    <div class="vibex-writer-body">\n      <div class="vibex-writer-section">\n        <label>What do you want to write about?</label>\n        <textarea id="vibex-writer-topic" placeholder="e.g., My thoughts on AI productivity tools..."></textarea>\n      </div>\n      <div class="vibex-writer-section">\n        <label>Tone</label>\n        <select id="vibex-writer-tone">\n          <option value="professional">Professional</option>\n          <option value="casual">Casual</option>\n          <option value="humorous">Humorous</option>\n          <option value="inspirational">Inspirational</option>\n          <option value="controversial">Controversial</option>\n        </select>\n      </div>\n      <div class="vibex-writer-section">\n        <label>Style</label>\n        <select id="vibex-writer-style">\n          <option value="thread">Thread (multiple tweets)</option>\n          <option value="single">Single tweet</option>\n          <option value="hook">Hook + Value</option>\n          <option value="story">Storytelling</option>\n        </select>\n      </div>\n      <div class="vibex-writer-section">\n        <label>\n          <input type="checkbox" id="vibex-writer-use-style"> \n          Match my writing style (from collected posts)\n        </label>\n      </div>\n      <button class="vibex-btn vibex-btn-primary vibex-btn-full" id="vibex-generate-btn">\n        ‚ú® Generate Post\n      </button>\n      <div class="vibex-writer-output" id="vibex-writer-output" style="display: none;">\n        <label>Generated Post</label>\n        <div id="vibex-generated-text"></div>\n        <div class="vibex-writer-actions">\n          <button class="vibex-btn vibex-btn-secondary" id="vibex-copy-btn">üìã Copy</button>\n          <button class="vibex-btn vibex-btn-secondary" id="vibex-insert-btn">üìù Insert</button>\n          <button class="vibex-btn vibex-btn-secondary" id="vibex-regenerate-btn">üîÑ Regenerate</button>\n        </div>\n      </div>\n    </div>\n  ',document.body.appendChild(d),document.getElementById("vibex-writer-close").addEventListener("click",h),document.getElementById("vibex-generate-btn").addEventListener("click",w),document.getElementById("vibex-copy-btn")?.addEventListener("click",E),document.getElementById("vibex-insert-btn")?.addEventListener("click",k),document.getElementById("vibex-regenerate-btn")?.addEventListener("click",w)}async function w(){const e=document.getElementById("vibex-writer-topic").value,t=document.getElementById("vibex-writer-tone").value,n=document.getElementById("vibex-writer-style").value,i=document.getElementById("vibex-writer-use-style").checked;if(!e.trim())return void alert("Please enter a topic");const o=document.getElementById("vibex-generate-btn");o.disabled=!0,o.textContent="‚è≥ Generating...";try{let s=[];i&&(s=(await g("posts")).slice(0,10).map(e=>e.text)),chrome.runtime.sendMessage({action:"generatePost",data:{topic:e,tone:t,style:n,samplePosts:s}},e=>{o.disabled=!1,o.textContent="‚ú® Generate Post",e&&e.success?function(e){const t=document.getElementById("vibex-writer-output"),n=document.getElementById("vibex-generated-text");t.style.display="block",n.textContent=e,document.getElementById("vibex-copy-btn").addEventListener("click",E),document.getElementById("vibex-insert-btn").addEventListener("click",k),document.getElementById("vibex-regenerate-btn").addEventListener("click",w)}(e.text):alert("Failed to generate post: "+(e?.error||"Unknown error"))})}catch(e){o.disabled=!1,o.textContent="‚ú® Generate Post",alert("Error generating post: "+e.message)}}function E(){const e=document.getElementById("vibex-generated-text").textContent;navigator.clipboard.writeText(e).then(()=>{const e=document.getElementById("vibex-copy-btn");e.textContent="‚úÖ Copied!",setTimeout(()=>e.textContent="üìã Copy",2e3)})}function k(){const e=document.getElementById("vibex-generated-text").textContent,t=document.querySelector(l);t?(t.focus(),document.execCommand("insertText",!1,e)):(E(),alert("Text copied! Open the compose box and paste."))}function f(e){const t=document.getElementById("vibex-status");t&&(t.textContent=e)}async function I(){const e=await g("posts"),t=await g("likes"),n={exportedAt:(new Date).toISOString(),posts:e,likes:t},i=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),o=URL.createObjectURL(i),s=document.createElement("a");s.href=o,s.download=`vibex-export-${(new Date).toISOString().split("T")[0]}.json`,s.click(),URL.revokeObjectURL(o)}function C(e,t,n){switch(e.action){case"collectPosts":return m("posts").then(e=>n({success:!0,count:e.length})),!0;case"collectLikes":return m("likes").then(e=>n({success:!0,count:e.length})),!0;case"getCollectedData":return Promise.all([g("posts"),g("likes")]).then(([e,t])=>n({posts:e,likes:t})),!0;case"openWriter":h(),n({success:!0});break;case"stopCollection":x(),n({success:!0})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",u):u()})();