(()=>{console.log("Vibex extension v2.0 loaded");const e='[data-testid="tweet"]',t='[data-testid="tweetText"]',n='[data-testid="reply"]',i='[data-testid="retweet"]',o='[data-testid="like"]',s='[data-testid="views"]',l='[data-testid="tweetTextarea_0"]';let r=!1,c=[],a=[],d=[],u=null;function b(){console.log("Vibex: Initializing...");const e=v();"profile"!==e&&"likes"!==e&&"tweet"!==e&&"replies_search"!==e||function(){if(document.getElementById("vibex-collector"))return;const e=v(),t="likes"===e,n="tweet"===e,i="replies_search"===e,o=document.createElement("div");o.id="vibex-collector",o.className="vibex-collector",o.innerHTML=`\n    <div class="vibex-collector-header">\n      <svg class="vibex-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">\n        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n      </svg>\n      <span>Vibex Collector</span>\n      <button class="vibex-close" id="vibex-collector-close">&times;</button>\n    </div>\n    <div class="vibex-collector-body">\n      <p class="vibex-collector-status" id="vibex-status">Ready to collect fresh ${t?"likes":n?"replies":i?"all replies":"posts"}</p>\n      <div class="vibex-collector-actions">\n        <button class="vibex-btn vibex-btn-primary" id="vibex-collect-btn">\n          ${t?"â¤ï¸ Collect Fresh Likes":n?"ğŸ’¬ Collect Fresh Replies":i?"ğŸ’¬ Collect All My Replies":"ğŸ“ Collect Fresh Posts"}\n        </button>\n        <button class="vibex-btn vibex-btn-secondary" id="vibex-export-btn">\n          ğŸ“¥ Export JSON\n        </button>\n      </div>\n      <div class="vibex-collector-stats" id="vibex-stats">\n        <span>Posts: <strong id="vibex-posts-count">0</strong></span>\n        <span>Likes: <strong id="vibex-likes-count">0</strong></span>\n        <span>Replies: <strong id="vibex-replies-count">0</strong></span>\n      </div>\n    </div>\n  `,document.body.appendChild(o),document.getElementById("vibex-collect-btn").addEventListener("click",()=>{x(t?"likes":n||i?"replies":"posts")}),document.getElementById("vibex-export-btn").addEventListener("click",B),document.getElementById("vibex-collector-close").addEventListener("click",()=>{o.style.display="none"}),async function(){const e=await y("posts"),t=await y("likes"),n=await y("replies"),i=document.getElementById("vibex-posts-count"),o=document.getElementById("vibex-likes-count"),s=document.getElementById("vibex-replies-count");i&&(i.textContent=e.length),o&&(o.textContent=t.length),s&&(s.textContent=n.length),c=e,a=t,d=n}()}(),"compose"!==e&&"home"!==e||function(){const e=document.querySelector(l);if(!e||document.getElementById("vibex-writer-btn"))return;const t=document.createElement("button");t.id="vibex-writer-btn",t.className="vibex-writer-btn",t.innerHTML="âœ¨ AI",t.title="Open Vibex AI Writer",t.addEventListener("click",f),e.parentElement.appendChild(t)}(),function(){if(document.getElementById("vibex-fab"))return;const e=document.createElement("div");e.id="vibex-fab",e.className="vibex-fab",e.innerHTML='\n    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">\n      <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n    </svg>\n  ',e.title="Vibex Menu",document.body.appendChild(e),e.addEventListener("click",w)}(),chrome.runtime.onMessage.addListener(L),function(){let e=window.location.pathname;setInterval(()=>{const t=window.location.pathname;t!==e&&(e=t,["vibex-collector","vibex-menu","vibex-writer"].forEach(e=>{const t=document.getElementById(e);t&&t.remove()}),u=null,setTimeout(b,500))},1e3)}()}function v(){const e=window.location.pathname,t=new URLSearchParams(window.location.search).get("q")||"";return e.includes("/likes")?"likes":e.includes("/status/")?"tweet":"/compose/tweet"===e?"compose":"/home"===e?"home":"/search"===e&&t.includes("filter:replies")?"replies_search":2!==e.split("/").length||["home","explore","notifications","messages","search"].includes(e.split("/")[1])?"other":"profile"}function m(){return window.location.pathname.split("/").filter(e=>e)[0]||null}function p(){const l=document.querySelectorAll(e),r=[];return l.forEach((e,l)=>{try{const l=function(e){const l=e.querySelector(t),r=l?l.innerText:"";let c="",a="";const d=e.querySelector('a[href*="/status/"]');if(d&&(c=d.href,a=c.split("/status/")[1]?.split("?")[0]?.split("/")[0]||""),!a){const t=e.querySelector("time")?.closest("a");t&&t.href.includes("/status/")&&(c=t.href,a=c.split("/status/")[1]?.split("?")[0]?.split("/")[0]||"")}const u=e.querySelector("time"),b=u?u.getAttribute("datetime"):"",v=u?u.innerText:"",m=function(e){const t=t=>{const n=e.querySelector(t);if(!n)return 0;const i=(n.innerText||n.getAttribute("aria-label")||"").match(/[\d,]+/);return i?parseInt(i[0].replace(/,/g,""),10):0};return{replies:t(n),retweets:t(i),likes:t(o),views:t(s)}}(e),p=function(e){const t=e.querySelector('[data-testid="User-Name"]');if(!t)return{author:"",handle:""};const n=t.querySelectorAll("a");return{author:n[0]?.innerText||"",handle:(n[1]?.innerText||n[0]?.href?.split("/").pop()||"").replace("@","")}}(e),x=function(e){const t=e.querySelector('[data-testid="socialContext"]');if(t&&t.textContent.includes("reposted"))return"retweet";if(e.querySelector('[data-testid="quoteTweet"]'))return"quote";const n=e.querySelector('div[data-testid="tweet"] > div > div > div > span');return n&&n.textContent.includes("Replying to")?"reply":"original"}(e),g=function(e){const t=null!==e.querySelector('[data-testid="tweetPhoto"]'),n=null!==e.querySelector('[data-testid="videoPlayer"]'),i=null!==e.querySelector('[data-testid="card.wrapper"]'),o=null!==e.querySelector('[data-testid="cardPoll"]'),s=[];return t&&s.push("image"),n&&s.push("video"),i&&s.push("card"),o&&s.push("poll"),{hasMedia:s.length>0,mediaTypes:s}}(e);return{id:a,text:r,url:c,timestamp:b,displayTime:v,type:x,...g,...m,...p,scrapedAt:(new Date).toISOString()}}(e);l&&l.id&&r.push(l)}catch(e){console.error("Vibex: Error scraping tweet",l,e)}}),r}async function x(e="posts"){if(r)return void g();r=!0;const t="likes"===e?a:"replies"===e?d:c,n=new Set(t.map(e=>e.id));let i=0,o=0,s=0;const l=await function(e){return new Promise(t=>{const n="likes"===e?"vibex_likes_updated":"replies"===e?"vibex_replies_updated":"vibex_posts_updated";chrome.storage.local.get([n],e=>{const i=e[n];t(i?new Date(i):null)})})}(e),u=l||new Date(Date.now()-2592e6);for(C(`Collecting fresh ${e}... (0 collected)`);r;){const l=p();let r=0;l.forEach(i=>{if(i.id&&!n.has(i.id)){const o=new Date(i.timestamp);if(!isNaN(o.getTime())&&o>u){if("replies"===e&&"reply"!==i.type)return;if("posts"===e&&"reply"===i.type)return;n.add(i.id),t.push(i),r++}}}),0===r?i++:i=0;const c=document.documentElement.scrollHeight,a=window.innerHeight+window.scrollY>=c-100;if(c===o&&a?s++:(s=0,o=c),C(`Collecting fresh ${e}... (${t.length} collected)`),i>=10&&s>=5)break;window.scrollBy(0,.8*window.innerHeight),await h("likes"===e?2e3:1500),t.length%50==0&&t.length>0&&(C(`Collecting fresh ${e}... (${t.length} collected) - pausing...`),await h(1e3))}return r=!1,C(`Done! ${t.length} fresh ${e} collected`),function(e,t){const n="likes"===e?"vibex_likes":"replies"===e?"vibex_replies":"vibex_posts",i={[n]:t,[`${n}_updated`]:(new Date).toISOString()};chrome.storage.local.set(i,()=>{console.log(`Vibex: Saved ${t.length} ${e} to storage`),chrome.runtime.sendMessage({action:"dataCollected",type:e,count:t.length})})}(e,t),t}function g(){r=!1,C("Collection stopped")}function h(e){return new Promise(t=>setTimeout(t,e))}function y(e){return new Promise(t=>{const n="likes"===e?"vibex_likes":"replies"===e?"vibex_replies":"vibex_posts";chrome.storage.local.get([n],e=>{t(e[n]||[])})})}function w(){let e=document.getElementById("vibex-menu");if(e)return void e.remove();const t=v(),n="profile"===t,i="profile"===t||"likes"===t,o="tweet"===t||"replies_search"===t,s="profile"===t;e=document.createElement("div"),e.id="vibex-menu",e.className="vibex-menu",e.innerHTML=`\n    ${n?'<button class="vibex-menu-item" id="vibex-menu-collect">\n      ğŸ“ Collect Fresh Posts\n    </button>':""}\n    ${i?'<button class="vibex-menu-item" id="vibex-menu-likes">\n      â¤ï¸ Collect Fresh Likes\n    </button>':""}\n    ${o?'<button class="vibex-menu-item" id="vibex-menu-replies">\n      ğŸ’¬ Collect Fresh Replies\n    </button>':""}\n    ${s?'<button class="vibex-menu-item" id="vibex-menu-all-replies">\n      ğŸ’¬ Collect All My Replies\n    </button>':""}\n    <button class="vibex-menu-item" id="vibex-menu-writer">\n      âœï¸ AI Writer\n    </button>\n    <button class="vibex-menu-item" id="vibex-menu-export">\n      ğŸ“¥ Export Data\n    </button>\n    <button class="vibex-menu-item" id="vibex-menu-dashboard">\n      ğŸ“Š Dashboard\n    </button>\n  `,document.body.appendChild(e),n&&document.getElementById("vibex-menu-collect").addEventListener("click",()=>{e.remove(),x("posts")}),i&&document.getElementById("vibex-menu-likes").addEventListener("click",()=>{e.remove();const t=m();t&&!window.location.pathname.includes("/likes")?window.location.href=`https://x.com/${t}/likes`:x("likes")}),o&&document.getElementById("vibex-menu-replies").addEventListener("click",()=>{e.remove(),x("replies")}),s&&document.getElementById("vibex-menu-all-replies").addEventListener("click",()=>{e.remove();const t=m();if(t){const e=`https://x.com/search?q=${encodeURIComponent(`from:${t} filter:replies`)}&src=typed_query&f=live`;window.location.href=e}}),document.getElementById("vibex-menu-writer").addEventListener("click",()=>{e.remove(),f()}),document.getElementById("vibex-menu-export").addEventListener("click",()=>{e.remove(),B()}),document.getElementById("vibex-menu-dashboard").addEventListener("click",()=>{e.remove(),chrome.runtime.sendMessage({action:"openDashboard"})}),setTimeout(()=>{document.addEventListener("click",function t(n){e.contains(n.target)||"vibex-fab"===n.target.id||(e.remove(),document.removeEventListener("click",t))})},100)}function f(){if(u)return u.remove(),void(u=null);u=document.createElement("div"),u.id="vibex-writer",u.className="vibex-writer",u.innerHTML='\n    <div class="vibex-writer-header">\n      <h3>âœ¨ Vibex AI Writer</h3>\n      <button class="vibex-close" id="vibex-writer-close">&times;</button>\n    </div>\n    <div class="vibex-writer-body">\n      <div class="vibex-writer-section">\n        <label>What do you want to write about?</label>\n        <textarea id="vibex-writer-topic" placeholder="e.g., My thoughts on AI productivity tools..."></textarea>\n      </div>\n      <div class="vibex-writer-section">\n        <label>Tone</label>\n        <select id="vibex-writer-tone">\n          <option value="professional">Professional</option>\n          <option value="casual">Casual</option>\n          <option value="humorous">Humorous</option>\n          <option value="inspirational">Inspirational</option>\n          <option value="controversial">Controversial</option>\n        </select>\n      </div>\n      <div class="vibex-writer-section">\n        <label>Style</label>\n        <select id="vibex-writer-style">\n          <option value="thread">Thread (multiple tweets)</option>\n          <option value="single">Single tweet</option>\n          <option value="hook">Hook + Value</option>\n          <option value="story">Storytelling</option>\n        </select>\n      </div>\n      <div class="vibex-writer-section">\n        <label>\n          <input type="checkbox" id="vibex-writer-use-style"> \n          Match my writing style (from collected posts)\n        </label>\n      </div>\n      <button class="vibex-btn vibex-btn-primary vibex-btn-full" id="vibex-generate-btn">\n        âœ¨ Generate Post\n      </button>\n      <div class="vibex-writer-output" id="vibex-writer-output" style="display: none;">\n        <label>Generated Post</label>\n        <div id="vibex-generated-text"></div>\n        <div class="vibex-writer-actions">\n          <button class="vibex-btn vibex-btn-secondary" id="vibex-copy-btn">ğŸ“‹ Copy</button>\n          <button class="vibex-btn vibex-btn-secondary" id="vibex-insert-btn">ğŸ“ Insert</button>\n          <button class="vibex-btn vibex-btn-secondary" id="vibex-regenerate-btn">ğŸ”„ Regenerate</button>\n        </div>\n      </div>\n    </div>\n  ',document.body.appendChild(u),document.getElementById("vibex-writer-close").addEventListener("click",f),document.getElementById("vibex-generate-btn").addEventListener("click",E),document.getElementById("vibex-copy-btn")?.addEventListener("click",k),document.getElementById("vibex-insert-btn")?.addEventListener("click",I),document.getElementById("vibex-regenerate-btn")?.addEventListener("click",E)}async function E(){const e=document.getElementById("vibex-writer-topic").value,t=document.getElementById("vibex-writer-tone").value,n=document.getElementById("vibex-writer-style").value,i=document.getElementById("vibex-writer-use-style").checked;if(!e.trim())return void alert("Please enter a topic");const o=document.getElementById("vibex-generate-btn");o.disabled=!0,o.textContent="â³ Generating...";try{let s=[];if(i){const e=await y("posts"),t=await y("replies");s=[...e,...t].slice(0,15).map(e=>e.text)}chrome.runtime.sendMessage({action:"generatePost",data:{topic:e,tone:t,style:n,samplePosts:s}},e=>{o.disabled=!1,o.textContent="âœ¨ Generate Post",e&&e.success?function(e){const t=document.getElementById("vibex-writer-output"),n=document.getElementById("vibex-generated-text");t.style.display="block",n.textContent=e,document.getElementById("vibex-copy-btn").addEventListener("click",k),document.getElementById("vibex-insert-btn").addEventListener("click",I),document.getElementById("vibex-regenerate-btn").addEventListener("click",E)}(e.text):alert("Failed to generate post: "+(e?.error||"Unknown error"))})}catch(e){o.disabled=!1,o.textContent="âœ¨ Generate Post",alert("Error generating post: "+e.message)}}function k(){const e=document.getElementById("vibex-generated-text").textContent;navigator.clipboard.writeText(e).then(()=>{const e=document.getElementById("vibex-copy-btn");e.textContent="âœ… Copied!",setTimeout(()=>e.textContent="ğŸ“‹ Copy",2e3)})}function I(){const e=document.getElementById("vibex-generated-text").textContent,t=document.querySelector(l);t?(t.focus(),document.execCommand("insertText",!1,e)):(k(),alert("Text copied! Open the compose box and paste."))}function C(e){const t=document.getElementById("vibex-status");t&&(t.textContent=e)}async function B(){const e=await y("posts"),t=await y("likes"),n=await y("replies"),i={exportedAt:(new Date).toISOString(),posts:e,likes:t,replies:n},o=new Blob([JSON.stringify(i,null,2)],{type:"application/json"}),s=URL.createObjectURL(o),l=document.createElement("a");l.href=s,l.download=`vibex-export-${(new Date).toISOString().split("T")[0]}.json`,l.click(),URL.revokeObjectURL(s)}function L(e,t,n){switch(e.action){case"collectPosts":return x("posts").then(e=>n({success:!0,count:e.length})),!0;case"collectLikes":return x("likes").then(e=>n({success:!0,count:e.length})),!0;case"collectReplies":return x("replies").then(e=>n({success:!0,count:e.length})),!0;case"getCollectedData":return Promise.all([y("posts"),y("likes"),y("replies")]).then(([e,t,i])=>n({posts:e,likes:t,replies:i})),!0;case"openWriter":f(),n({success:!0});break;case"stopCollection":g(),n({success:!0})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",b):b()})();